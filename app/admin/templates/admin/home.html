{% extends "admin/base.html" %}

{% block title %}
    Admin Dashboard - Ecommerce Review Insights
{% endblock %}

{% block content %}
    {% with msgs = get_flashed_messages(with_categories=True) %}
        {% for c, msg in msgs %}
            <div class="{{ 'flash-error' if c == 'error' else 'flash-success' }}">
                {{ msg }}
            </div><br>
        {% endfor %}
    {% endwith %}

    <div class="container-fluid py-4 px-5" style="background: #f8f9fa; min-height: 100vh;">
        <h2 class="text-center mb-5" style="font-weight: 700; color: #343a40;">üìä E-commerce Review Intelligence Dashboard</h2>

        <!-- Summary Cards -->
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card text-white bg-primary shadow rounded-4">
                    <div class="card-body text-center">
                        <h5>Total Reviews</h5>
                        <h2>{{ analyzed_reviews | length }}</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-white bg-success shadow rounded-4">
                    <div class="card-body text-center">
                        <h5>Original Reviews</h5>
                        <h2>{{ analyzed_reviews | selectattr("result", "equalto", "Original") | list | length }}</h2>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card text-white bg-danger shadow rounded-4">
                    <div class="card-body text-center">
                        <h5>Fake Reviews</h5>
                        <h2>{{ analyzed_reviews | selectattr("result", "equalto", "Fake") | list | length }}</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="row mt-5 g-4">
            <div class="col-lg-6">
                <div class="card shadow-lg rounded-4 p-4">
                    <h5 class="card-title text-center mb-4">üïµÔ∏è Fake vs Original Reviews</h5>
                    <canvas id="reviewChart" height="300"></canvas>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card shadow-lg rounded-4 p-4">
                    <h5 class="card-title text-center mb-4">üòä Sentiment Analysis</h5>
                    <canvas id="sentimentChart" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Additional Visuals -->
        <div class="row mt-5 g-4">
            <div class="col-lg-6">
                <div class="card shadow-lg rounded-4 p-4">
                    <h5 class="card-title text-center mb-4">üìà Monthly Review Trend</h5>
                    <canvas id="trendChart" height="300"></canvas>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card shadow-lg rounded-4 p-4">
                    <h5 class="card-title text-center mb-4">üìä Gauge - Overall Positive Sentiment</h5>
                    <canvas id="gaugeChart" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-doughnutlabel@1.0.0"></script>
    <script>
        const total = {{ analyzed_reviews | length }};
        const fakeCount = {{ analyzed_reviews | selectattr("result", "equalto", "Fake") | list | length }};
        const originalCount = {{ analyzed_reviews | selectattr("result", "equalto", "Original") | list | length }};
        const posSent = {{ analyzed_reviews | selectattr("sentiment", "equalto", "Positive") | list | length }};
        const negSent = {{ analyzed_reviews | selectattr("sentiment", "equalto", "Negative") | list | length }};

        // Pie Chart - Fake vs Original
        new Chart(document.getElementById('reviewChart').getContext('2d'), {
            type: 'pie',
            data: {
                labels: ['Fake Reviews', 'Original Reviews'],
                datasets: [{
                    data: [fakeCount, originalCount],
                    backgroundColor: ['#ff6b6b', '#51cf66']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // Bar Chart - Sentiment
        new Chart(document.getElementById('sentimentChart').getContext('2d'), {
            type: 'bar',
            data: {
                labels: ['Positive', 'Negative'],
                datasets: [{
                    label: 'Sentiment Count',
                    data: [posSent, negSent],
                    backgroundColor: ['#339af0', '#ff922b']
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { display: false } }
            }
        });

        // Trend Chart - Monthly Reviews (Dummy Monthly Data)
        new Chart(document.getElementById('trendChart').getContext('2d'), {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Total Reviews',
                    data: [1000, 1200, 1300, 1100, 1500, 1400],
                    borderColor: '#6741d9',
                    backgroundColor: 'rgba(103, 65, 217, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        // Gauge-like Doughnut Chart
        new Chart(document.getElementById('gaugeChart').getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Positive', 'Remaining'],
                datasets: [{
                    data: [posSent, total - posSent],
                    backgroundColor: ['#51cf66', '#dee2e6'],
                    borderWidth: 0
                }]
            },
            options: {
                rotation: -90,
                circumference: 180,
                cutout: '80%',
                plugins: {
                    legend: { display: false },
                    doughnutlabel: {
                        labels: [{
                            text: Math.round((posSent / total) * 100) + '%',
                            font: { size: '20' },
                            color: '#343a40'
                        }]
                    }
                }
            }
        });
    </script>
{% endblock %}
